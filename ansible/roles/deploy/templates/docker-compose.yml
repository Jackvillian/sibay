version: '2'
services:

  push_app:
    image: jacvmos/push_app:{{tag[0]}}
    volumes:
        - /app/src:/usr/src/app
        - /app/data/:/usr/src/app/data
    links:
      - redisdb:redisdb
      - mysqldb:mysqldb

  bot_app:
    image: jacvmos/bot_app:{{tag[0]}}
    volumes:
        - /app/src:/usr/src/app
        - /app/data/:/usr/src/app/data
    links:
      - redisdb:redisdb
      - mysqldb:mysqldb

  messenger_worker:
    image: jacvmos/celery_app:{{tag[0]}}
    volumes:
        - /app/src:/usr/src/app
        - /app/data/:/usr/src/app/data
    links:
      - redisdb:redisdb
      - mysqldb:mysqldb
    command: alembic upgrade head

  redisdb:
    image: redis:latest

  mysqldb:
    image: mysql:latest
    environment:
      - MYSQL_ROOT_PASSWORD={{mysql_root[0]}}
      - MYSQL_DATABASE={{mysql_db[0]}}
      - MYSQL_USER={{mysql_user[0]}}
      - MYSQL_PASSWORD={{mysql_password[0]}}